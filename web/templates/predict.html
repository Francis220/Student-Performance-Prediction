{% extends "base.html" %}

{% block title %}Upload Class Data - Student Performance Prediction{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-upload"></i> Upload Class Data</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

{% if models_available %}
<div class="row">
    <!-- Upload Interface -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> Upload Your Student Data</h5>
            </div>
            <div class="card-body">
                <div class="upload-area text-center p-5 border border-dashed rounded" id="upload-area">
                    <i class="fas fa-cloud-upload-alt fa-4x text-muted mb-3"></i>
                    <h4>Drag & Drop Your File Here</h4>
                    <p class="text-muted mb-3">or click to browse and select your student data file</p>
                    <form id="upload-form" enctype="multipart/form-data">
                        <input type="file" id="file-input" name="class_data" accept=".csv,.xlsx,.xls" style="display: none;">
                        <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('file-input').click()">
                            <i class="fas fa-folder-open"></i> Choose File
                        </button>
                    </form>
                </div>
                
                <div class="mt-4" id="file-info" style="display: none;">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-csv fa-2x me-3"></i>
                            <div>
                                <strong id="file-name"></strong>
                                <br><small id="file-details"></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="class-name" class="form-label">
                                <strong>Class Name</strong>
                            </label>
                            <input type="text" class="form-control" id="class-name" placeholder="e.g., Math 10A, Portuguese 11B">
                        </div>
                        <div class="col-md-6">
                            <label for="school-year" class="form-label">
                                <strong>School Year</strong>
                            </label>
                            <input type="text" class="form-control" id="school-year" placeholder="e.g., 2023-2024">
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-success btn-lg" id="analyze-btn">
                            <i class="fas fa-chart-line"></i> Analyze Class Risk
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions and Information -->
    <div class="col-lg-4">
        <!-- Supported Formats -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Supported File Types</h6>
            </div>
            <div class="card-body">
                <div class="format-item mb-2">
                    <i class="fas fa-file-csv text-success me-2"></i>
                    <strong>CSV files</strong> (.csv)
                </div>
                <div class="format-item mb-2">
                    <i class="fas fa-file-excel text-success me-2"></i>
                    <strong>Excel files</strong> (.xlsx, .xls)
                </div>
                <div class="alert alert-warning small mt-3">
                    <strong>Note:</strong> Your data stays on your school's server. We only analyze the patterns to identify risk factors.
                </div>
            </div>
        </div>

        <!-- Expected Data Format -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-table"></i> Expected Data Format</h6>
            </div>
            <div class="card-body">
                <p class="small text-muted">Your file should include these columns:</p>
                <div class="data-column mb-2">
                    <strong>Required:</strong>
                    <ul class="small">
                        <li>Student names/IDs</li>
                        <li>Home address (urban/rural)</li>
                        <li>Study time per week</li>
                        <li>Social activity frequency</li>
                        <li>Educational support level</li>
                    </ul>
                </div>
                <div class="data-column">
                    <strong>Optional:</strong>
                    <ul class="small">
                        <li>Previous grades</li>
                        <li>Attendance records</li>
                        <li>Family information</li>
                        <li>Other risk factors</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Sample Data -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-download"></i> Sample Template</h6>
            </div>
            <div class="card-body text-center">
                <p class="small text-muted">Not sure about the format? Download our template:</p>
                <button class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-download"></i> Download Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Processing State (Hidden by default) -->
<div class="row mt-4" id="processing-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-cog fa-spin"></i> Analyzing Your Class Data</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="analysis-progress" role="progressbar" style="width: 0%">
                        0%
                    </div>
                </div>
                <div id="analysis-status" class="text-center">
                    Uploading and validating data...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Preview (Hidden by default) -->
<div class="row mt-4" id="results-preview" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle"></i> Analysis Complete</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-md-3">
                        <div class="metric-card bg-primary text-white">
                            <div class="metric-number" id="total-students">0</div>
                            <div class="metric-label">Students Analyzed</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-danger text-white">
                            <div class="metric-number" id="high-risk-count">0</div>
                            <div class="metric-label">High Risk</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-warning text-white">
                            <div class="metric-number" id="medium-risk-count">0</div>
                            <div class="metric-label">Medium Risk</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-success text-white">
                            <div class="metric-number" id="low-risk-count">0</div>
                            <div class="metric-label">Low Risk</div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-lg me-2">
                        <i class="fas fa-chart-line"></i> View Detailed Results
                    </a>
                    <button class="btn btn-outline-secondary btn-lg" onclick="resetUpload()">
                        <i class="fas fa-plus"></i> Upload Another Class
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <h4>System Setup Required</h4>
            <p>The AI analysis models need to be set up before you can upload and analyze class data.</p>
            <a href="{{ url_for('train_model') }}" class="btn btn-primary">
                <i class="fas fa-cogs"></i> Complete System Setup
            </a>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<style>
.upload-area {
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    background-color: #e9ecef;
    border-color: #007bff !important;
}

.upload-area.dragover {
    background-color: #cce7ff;
    border-color: #007bff !important;
}

.format-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid #eee;
}

.format-item:last-child {
    border-bottom: none;
}

.data-column ul {
    margin-bottom: 0.5rem;
}

.metric-card {
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 1rem;
    opacity: 0.9;
}
</style>

<script>
// File upload handling
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');
const fileInfo = document.getElementById('file-info');

// Click to upload
uploadArea.addEventListener('click', () => {
    fileInput.click();
});

// Drag and drop functionality
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

// File selection handling
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    // Validate file type
    const allowedTypes = ['.csv', '.xlsx', '.xls'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    
    if (!allowedTypes.includes(fileExtension)) {
        alert('Please select a CSV or Excel file.');
        return;
    }
    
    // Display file info
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-details').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB â€¢ ${fileExtension.toUpperCase()} file`;
    
    fileInfo.style.display = 'block';
}

// Analysis process
document.getElementById('analyze-btn').addEventListener('click', function() {
    const className = document.getElementById('class-name').value;
    const schoolYear = document.getElementById('school-year').value;
    
    if (!className.trim()) {
        alert('Please enter a class name.');
        return;
    }
    
    // Show processing section
    document.getElementById('processing-section').style.display = 'block';
    this.disabled = true;
    
    // Simulate analysis progress
    let progress = 0;
    const progressBar = document.getElementById('analysis-progress');
    const statusText = document.getElementById('analysis-status');
    
    const steps = [
        'Uploading and validating data...',
        'Identifying student records...',
        'Analyzing risk factors...',
        'Running AI predictions...',
        'Generating recommendations...',
        'Preparing dashboard...',
        'Analysis complete!'
    ];
    
    let currentStep = 0;
    const totalSteps = steps.length;
    
    const updateProgress = () => {
        if (currentStep < totalSteps) {
            progress = Math.round((currentStep / totalSteps) * 100);
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            statusText.textContent = steps[currentStep];
            currentStep++;
            
            setTimeout(updateProgress, 1500);
        } else {
            // Analysis complete - show results
            showResults();
        }
    };
    
    setTimeout(updateProgress, 500);
});

function showResults() {
    // Simulate analysis results
    const totalStudents = Math.floor(Math.random() * 20) + 25; // 25-45 students
    const highRisk = Math.floor(Math.random() * 8) + 2; // 2-10 high risk
    const mediumRisk = Math.floor(Math.random() * 12) + 5; // 5-17 medium risk
    const lowRisk = totalStudents - highRisk - mediumRisk;
    
    document.getElementById('total-students').textContent = totalStudents;
    document.getElementById('high-risk-count').textContent = highRisk;
    document.getElementById('medium-risk-count').textContent = mediumRisk;
    document.getElementById('low-risk-count').textContent = lowRisk;
    
    document.getElementById('results-preview').style.display = 'block';
    
    // Update progress to complete
    const progressBar = document.getElementById('analysis-progress');
    const statusText = document.getElementById('analysis-status');
    
    progressBar.style.width = '100%';
    progressBar.textContent = '100%';
    progressBar.classList.remove('progress-bar-animated');
    progressBar.classList.add('bg-success');
    statusText.textContent = 'Analysis complete! Your class data has been processed and risk assessments are ready.';
}

function resetUpload() {
    // Reset the form
    document.getElementById('upload-form').reset();
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('processing-section').style.display = 'none';
    document.getElementById('results-preview').style.display = 'none';
    document.getElementById('analyze-btn').disabled = false;
    
    // Clear input fields
    document.getElementById('class-name').value = '';
    document.getElementById('school-year').value = '';
}
</script>
{% endblock %} 